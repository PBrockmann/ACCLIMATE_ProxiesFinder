/*!
 * dc-addons v0.13.1
 *
 * 2016-04-08 11:34:39
 *
 */
// node modules
function connect(a){var b=mysql.createConnection({host:a.host,user:a.username,password:a.password,database:a.database});return b.connect(),b}function execute(a,b,c){a.query(b,function(a,b){if(a)throw a;console.log("Number of rows: "+b.length),c(crossfilter(b))})}function addTiming(a){var b=(new Date).getTime(),c=0;timing.length>0&&(c=b-timing[timing.length-1].time),timing.push({name:a,took:c,time:b})}function logTiming(){console.log("---------------"),console.log("Server Timing");for(var a=timing[timing.length-1].time-timing[0].time,b=0;b<timing.length;b++)console.log(timing[b].name+" took "+timing[b].took/1e3+" seconds ("+(timing[b].took/a*100).toFixed(3)+"%)");console.log("Total time: "+a/1e3+" seconds"),console.log("---------------"),timing=[]}var app=require("express")(),http=require("http").Server(app),request=require("request"),io=require("socket.io")(http),jsdom=require("jsdom"),mysql=require("mysql"),crossfilter=require("crossfilter"),timing=[],configFile=process.argv[2];
// socket connections
io.on("connection",function(a){function b(){if(f.mysql){var a=connect(f.mysql);addTiming("connected to db"),execute(a,f.mysql.sql,function(a){addTiming("sql query completed"),c(a)})}else f.api&&("function"==typeof f.api.before&&f.api.before({conditions:g}),request(f.api.options,function(a,b,d){a||(addTiming("connected to api"),c(crossfilter(f.api.after(d))))}))}function c(b){var c=h.document.getElementsByTagName("body")[0];c.innerHTML="",f.charts.forEach(function(a,d){try{
// create the div container for the chart
var g=h.document.createElement("div");g.setAttribute("data-type",a.type),g.className=g.className+" dc-server-chart",c.appendChild(g),
// parse the options
"function"==typeof a.options.dimension&&(a.options.dimension=b.dimension(a.options.dimension)),"function"==typeof a.options.group&&(a.options.group=a.options.group(b,a.options.dimension));
// create and render the chart
var i=h.dc[a.type](g);i.options(a.options).render(),addTiming("chart number "+(d+1)+" of "+f.charts.length+" rendered"),e.push(i)}catch(a){console.trace(),console.warn(a)}}),logTiming(),a.emit("afterRender",c.innerHTML)}function d(){var b=[];f.charts.forEach(function(a,c){b.push({type:a.type,width:a.options.width,height:a.options.height})}),a.emit("preRender",b)}var e=[],f={},g=null,h=null;a.on("render",function(a){addTiming("start"),
// clear the cache for the config file
delete require.cache[require.resolve(configFile)];
// load the config
var c=require(configFile);f=c[a],e=[],d(),c.libraries||(c.libraries={}),c.libraries.d3||(c.libraries.d3="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"),c.libraries.crossfilter||(c.libraries.crossfilter="https://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.11/crossfilter.min.js"),c.libraries.dc||(c.libraries.dc="https://cdnjs.cloudflare.com/ajax/libs/dc/2.0.0-beta.12/dc.min.js");var g='<html><head><script src="'+c.libraries.d3+'"></script><script src="'+c.libraries.crossfilter+'"></script><script src="'+c.libraries.dc+'"></script></head><body></body></html>';addTiming("config loaded"),jsdom.env({features:{QuerySelector:!0},virtualConsole:jsdom.createVirtualConsole().sendTo(console),html:g,done:function(a,c){addTiming("jsdom loaded"),h=c,c.dc.disableTransitions=!0,b()}})}),a.on("filter",function(b){addTiming("filtering started");try{var c=e[b[0]];if("object"==typeof b[1])if(null===b[1][0]||null===b[1][1])c.filter(null);else{var d=c.effectiveWidth(),f=c.x().domain(),g=[b[1][0]/d*(f[1]-f[0])+f[0],b[1][1]/d*(f[1]-f[0])+f[0]];g.isFiltered=function(a){return a>=this[0]&&a<this[1]},c.brush().extent(g),c.replaceFilter(g)}else c.filter(c.keyAccessor()(c.group().all()[b[1]]));addTiming("charts filtered"),c.redrawGroup(),h.dc.redrawAll(),addTiming("charts redrawn"),a.emit("afterFilter",h.document.body.innerHTML),addTiming("filtering sent"),logTiming()}catch(b){console.log(b),a.emit("afterFilterError",b)}}),a.on("updateConditions",function(a){g=a,null!==h&&(d(),b())}),a.on("disconnect",function(){console.log("user disconnected")})}),http.listen(3e3,function(){console.log("Listening on http://127.0.0.1:3000/")});